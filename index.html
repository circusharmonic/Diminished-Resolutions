<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diminished Resolutions</title>
    <style>
        :root {
            --scale-factor: 1;
            --base-width: 720px;
            --base-height: 500px;
        }

        whole {
            margin: auto;
            height: auto;
            padding: calc(0px * var(--scale-factor));
            background: transparent;
            display: block;
            min-height: 10vh;
        }

        description {
            margin: auto;
            background: #1a1a1a;
            display: block;
            align-items: center;
            margin-top: calc(10px * var(--scale-factor));
            font-family: Helvetica, sans-serif;
        }

        #dcontainer {
            width: calc(var(--base-width) * var(--scale-factor) - 66px * var(--scale-factor));
            height: auto;
            top: calc(-10px * var(--scale-factor));
            background: #2a2a2a;
            border-radius: calc(10px * var(--scale-factor));
            padding: calc(20px * var(--scale-factor));
            box-shadow: 0 calc(4px * var(--scale-factor)) calc(20px * var(--scale-factor)) rgba(0,0,0,0.5);
            position: relative;
        }

        #dtextcontainer {
            margin: calc(12px * var(--scale-factor));
            margin-top: calc(4px * var(--scale-factor));
            margin-bottom: calc(6px * var(--scale-factor));
            color: white;
            z-index: 10;
        }

        .dtext {
            top: calc(32px * var(--scale-factor));
            color: white;
        }

        body {
            margin: 0;
            padding: calc(10px * var(--scale-factor));
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            font-family: Helvetica, sans-serif;
            overflow-x: hidden;
        }

        #container {
            width: calc(var(--base-width) * var(--scale-factor) - 66px * var(--scale-factor));
            height: calc(var(--base-height) * var(--scale-factor) - 50px * var(--scale-factor));
            top: calc(-10px * var(--scale-factor));
            background: #2a2a2a;
            border-radius: calc(10px * var(--scale-factor));
            padding: calc(20px * var(--scale-factor));
            box-shadow: 0 calc(4px * var(--scale-factor)) calc(20px * var(--scale-factor)) rgba(0,0,0,0.5);
            position: relative;
        }

        #title-container {
            position: absolute;
            top: calc(26px * var(--scale-factor));
            left: calc(40px * var(--scale-factor));
            color: white;
            z-index: 10;
            font-family: Helvetica, sans-serif;
        }

        #main-title {
            font-size: calc(30px * var(--scale-factor));
            font-weight: bold;
            margin-bottom: calc(5px * var(--scale-factor));
        }

        #subtitle {
            font-size: calc(20px * var(--scale-factor));
            font-style: italic;
        }

        #dropdown-container {
            position: absolute;
            right: calc(53px * var(--scale-factor));
            top: calc(6px * var(--scale-factor));
            margin-top: calc(20px * var(--scale-factor));
            margin-bottom: calc(10px * var(--scale-factor));
            z-index: 10;
        }

        #dropdown {
            background: #1a1a1a80;
            color: #ffffff;
            border: calc(2px * var(--scale-factor)) solid #1a1a1a00;
            border-radius: calc(8px * var(--scale-factor));
            width: calc(220px * var(--scale-factor));
            height: calc(36px * var(--scale-factor));
            padding: calc(8px * var(--scale-factor)) calc(19px * var(--scale-factor));
            font-family: Helvetica, sans-serif;
            font-size: calc(14px * var(--scale-factor));
            cursor: pointer;
            outline: none;
        }

        #main-content {
            width: calc(var(--base-width) * var(--scale-factor));
            height: calc(460px * var(--scale-factor));
            position: relative;
            margin-top: calc(-6px * var(--scale-factor));
            margin-bottom: calc(10px * var(--scale-factor));
        }
        
        /* Label text */
        #label-container {
            position: relative;
            justify-content: center;
            top: calc(430px * var(--scale-factor));
            width: calc(680px * var(--scale-factor));
            height: calc(60px * var(--scale-factor));
        }
        
        .label-text {
            position: absolute;
            font-size: calc(20px * var(--scale-factor));
            color: white;
        }
        
        #left-label {
            left: calc(120px * var(--scale-factor));
            transform: translateX(-50%);
        }
        
        #right-label {
            left: calc(565px * var(--scale-factor));
            transform: translateX(-50%);
        }
        
        .arrow {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: calc(36px * var(--scale-factor));
            color: white;
            width: calc(180px * var(--scale-factor));
            height: calc(36px * var(--scale-factor));
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .arrow svg {
            width: 90%;
            height: 90%;
        }
        
        /* Circle of Fifths */
        #circle-container {
            position: absolute;
            left: calc(20px * var(--scale-factor));
            top: calc(40px * var(--scale-factor));
            width: calc(240px * var(--scale-factor));
            height: calc(400px * var(--scale-factor));
        }
        
        .note-circle {
            position: absolute;
            width: calc(44px * var(--scale-factor));
            height: calc(44px * var(--scale-factor));
            border-radius: 50%;
            background: rgba(26, 26, 26, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(16px * var(--scale-factor));
            color: white;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: background 0.15s ease, width 0.15s ease, height 0.15s ease;
        }
        
        .note-circle.active.red {
            background: rgba(255, 61, 64, 1);
            width: calc(46.64px * var(--scale-factor));
            height: calc(46.64px * var(--scale-factor));
        }
        
        .note-circle.active.green {
            background: rgba(51, 230, 107, 1);
            width: calc(46.64px * var(--scale-factor));
            height: calc(46.64px * var(--scale-factor));
        }
        
        #center-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: calc(16px * var(--scale-factor));
            color: white;
            text-align: center;
        }
        
        /* Chart */
        #chart-container {
            position: absolute;
            right: calc(28px * var(--scale-factor));
            top: calc(40px * var(--scale-factor));
            width: calc(430px * var(--scale-factor));
            height: calc(400px * var(--scale-factor));
        }
        
        #svg-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .left-box {
            position: absolute;
            height: calc(36px * var(--scale-factor));
            border-radius: calc(8px * var(--scale-factor));
            background: rgba(255, 119, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(14px * var(--scale-factor));
            color: white;
            cursor: pointer;
            transition: background 0.15s ease, width 0.15s ease;
        }
        
        .left-box.narrow {
            width: calc(80px * var(--scale-factor));
        }
        
        .left-box.wide {
            width: calc(226px * var(--scale-factor));
        }
        
        .left-box.active {
            background: rgba(255, 119, 0, 1);
        }
        
        .right-box {
            position: absolute;
            height: calc(36px * var(--scale-factor));
            border-radius: calc(8px * var(--scale-factor));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(14px * var(--scale-factor));
            color: white;
            transition: background 0.15s ease, width 0.15s ease;
        }
        
        .right-box.narrow {
            width: calc(80px * var(--scale-factor));
        }
        
        .right-box.wide {
            width: calc(220px * var(--scale-factor));
        }
        
        .right-box.green {
            background: rgba(51, 230, 107, 0.6);
        }
        
        .right-box.red {
            background: rgba(255, 61, 64, 0.6);
        }
    </style>
</head>
<whole>
    <body>
        <div id="container">
            <div id="title-container">
                <div id="main-title">Diminished Resolutions</div>
                <div id="subtitle">by CircusHarmonic</div>
            </div>
            <div id="dropdown-container">
                <select id="dropdown">
                    <option value="0">Diminished → Resolution</option>
                    <option value="1">Resolution → Diminished</option>
                </select>
            </div>
            <div id="main-content">
                <div id="circle-container">
                    <div id="center-text"></div>
                </div>
                <div id="chart-container">
                    <svg id="svg-lines"></svg>
                </div>
                <div id="label-container">
                    <span id="left-label" class="label-text">Diminished</span>
                    <span id="arrow" class="arrow">
                        <svg viewBox="0 0 180 36" xmlns="http://www.w3.org/2000/svg">
                            <line x1="9" y1="13" x2="157.5" y2="13" stroke="white" stroke-width="2.7"/>
                            <polygon points="171,13 153,5.8 153,20.2" fill="white"/>
                        </svg>
                    </span>
                    <span id="right-label" class="label-text">Resolution</span>
                </div>
            </div>
        </div>
        <description>
            <div id="dcontainer">
                <div id="dtextcontainer">
                    <div id="dtext"><span style="white-space: pre-line; font-size: calc(12px * var(--scale-factor));">Every diminished 7 chord can resolve to 4 unique dominant 7 chords by moving any chord tone down by a semitone.

                    This project aims to help visualise these resolution pathways by starting from a diminished 7, or working backwards from a resolution key. Use the dropdown menu to switch between these modes, and click around the circle of fifths and chord suggestions to set your desired pathway.

                    The six most common jazz cadences are displayed, opening potential modulations to and from any key, but these pathways are non exhaustive, so please explore your own modal and non-tonic resolutions :)</span></div>
                </div>
            </div>
        </description>

        <script>
            // Function to calculate and set the scale factor based on viewport size
            function updateScaleFactor() {
                const baseWidth = 720;
                const baseHeight = 500;
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // Calculate scale factors for width and height
                const widthScale = (viewportWidth - 40) / baseWidth;  // 40px for margins
                const heightScale = (viewportHeight - 40) / (baseHeight + 160); // Add height for description
                
                // Use the smaller scale factor to ensure everything fits
                let scaleFactor = Math.min(widthScale, heightScale, 1.5); // Cap at 1.5x
                
                // Set a minimum scale to prevent too small rendering
                scaleFactor = Math.max(scaleFactor, 0.5);
                
                // Update the CSS variable
                document.documentElement.style.setProperty('--scale-factor', scaleFactor);
                
                // Update JavaScript variables that depend on scale
                centerX = 120 * scaleFactor;
                centerY = 200 * scaleFactor;
                outerRadius = 93.6 * scaleFactor;
                boxHeight = 36 * scaleFactor;
                spacing = 20 * scaleFactor;
                
                // Update configuration objects
                MODE_CONFIG[0].leftBoxWidth = 80 * scaleFactor;
                MODE_CONFIG[0].rightBoxWidth = 220 * scaleFactor;
                MODE_CONFIG[0].leftBoxX = 45 * scaleFactor;
                MODE_CONFIG[0].curvature = 26 * scaleFactor;
                
                MODE_CONFIG[1].leftBoxWidth = 220 * scaleFactor;
                MODE_CONFIG[1].rightBoxWidth = 80 * scaleFactor;
                MODE_CONFIG[1].leftBoxX = 65 * scaleFactor;
                MODE_CONFIG[1].curvature = 20 * scaleFactor;
                
                // Refresh the UI with new scaling
                if (initialized) {
                    createBoxes();
                    updateNotePositions();
                    drawLines();
                }
            }

            // ========================================
            // MODE CONFIGURATIONS
            // ========================================
            const MODE_CONFIG = {
                0: { // Diminished -> Resolution
                    numLeftBoxes: 4,
                    numRightBoxes: 6,
                    leftBoxWidth: 80,
                    leftBoxClass: 'narrow',
                    rightBoxWidth: 220,
                    rightBoxClass: 'wide',
                    circleActiveClass: 'red',
                    rightBoxColorClass: 'green',
                    leftLabel: 'Diminished',
                    rightLabel: 'Resolution',
                    centerText: '°7 Pivot Chord',
                    leftBoxX: 45,
                    curvature: 26,
                    arrowSVG: `
                        <svg viewBox="0 0 180 36" xmlns="http://www.w3.org/2000/svg">
                            <line x1="9" y1="13" x2="157.5" y2="13" stroke="white" stroke-width="2.7"/>
                            <polygon points="171,13 153,5.8 153,20.2" fill="white"/>
                        </svg>
                    `
                },
                1: { // Resolution -> Diminished
                    numLeftBoxes: 6,
                    numRightBoxes: 4,
                    leftBoxWidth: 220,
                    leftBoxClass: 'wide',
                    rightBoxWidth: 80,
                    rightBoxClass: 'narrow',
                    circleActiveClass: 'green',
                    rightBoxColorClass: 'red',
                    leftLabel: 'Resolution',
                    rightLabel: 'Diminished',
                    centerText: 'Resolution Key',
                    leftBoxX: 65,
                    curvature: 20,
                    arrowSVG: `
                        <svg viewBox="0 0 180 36" xmlns="http://www.w3.org/2000/svg">
                            <line x1="22.5" y1="13" x2="171" y2="13" stroke="white" stroke-width="2.7"/>
                            <polygon points="9,13 27,5.8 27,20.2" fill="white"/>
                        </svg>
                    `
                }
            };

            // ========================================
            // GLOBAL VARIABLES
            // ========================================
            const notes = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
            let activeNote = 0;
            let rotationOffset = 0;
            let targetRotation = 0;
            let animating = false;
            const animationSpeed = 0.12;
            let activeLeftBox = 0;
            let dropdownMode = 0; // 0 = Diminished->Resolution, 1 = Resolution->Diminished
            let initialized = false;

            // Box quantity variables
            let numLeftBoxes = 4;
            let numRightBoxes = 6;

            const circleContainer = document.getElementById('circle-container');
            const chartContainer = document.getElementById('chart-container');
            const svgLines = document.getElementById('svg-lines');

            // These values will be updated by updateScaleFactor()
            let centerX = 120;
            let centerY = 200;
            let outerRadius = 93.6;
            let boxHeight = 36;
            let spacing = 20;
            
            let centerText = '°7 Pivot Chord';
            const centerTextElement = document.getElementById('center-text');
            // ========================================
            // BOX DATA
            // ========================================

            let domlist = [
                { label: "B7" },
                { label: "D7" },
                { label: "F7" },
                { label: "Ab7" }
            ];

            let reslist = [
                { label: "E (Perfect)" },
                { label: "Db (Back Door)" },
                { label: "C (Screen Door)" },
                { label: "Bb (Tritone Perfect)" },
                { label: "G (Tritone Back Door)" },
                { label: "F# (Tritone Screen Door / Plagal)" }
            ];

            let dimlist = [
                { label: "Ab°7" },
                { label: "F°7" },
                { label: "D°7" },
                { label: "B°7" }
            ];

            let dompivotlist = [
                { label: "G7 (Perfect)" },
                { label: "Bb7 (Back Door)" },
                { label: "B7 (Screen Door)" },
                { label: "Db7 (Tritone Perfect)" },
                { label: "E7 (Tritone Back Door)" },
                { label: "F7 (Tritone Screen Door / Plagal)" }
            ];

            let leftBoxes = domlist;
            let rightBoxes = reslist;

            // ========================================
            // NOTE CIRCLE CREATION
            // ========================================
            const noteElements = [];
            notes.forEach((note, i) => {
                const el = document.createElement('div');
                el.className = 'note-circle';
                el.textContent = note;
                el.dataset.index = i;
                circleContainer.appendChild(el);
                noteElements.push(el);
                
                el.addEventListener('click', () => {
                    activeNote = i;
                    targetRotation = i * 30;
                    animating = true;

                    switch (dropdownMode) {
                        case 0:
                            calculatedoms(activeNote);
                            dom7labels(dom1, dom2, dom3, dom4);
                            calculateresolutions(activeLeftBox);
                            resolutionlabels(res1, res2, res3, res4, res5, res6);
                            break;
                        case 1:
                            calculatepivots(activeNote);
                            resolutionlabels(piv1, piv2, piv3, piv4, piv5, piv6);
                            calculatedims(activeLeftBox);
                            dim7labels(dim1, dim2, dim3, dim4);
                            break;
                    }
                    updateLeftBoxes();
                    updateRightBoxes();
                    updateActiveStates();
                    animate();
                });
            });

            // ========================================
            // BOX CREATION AND MANAGEMENT
            // ========================================
            let leftBoxElements = [];
            let rightBoxElements = [];
            
            function createBoxes() {
                const config = MODE_CONFIG[dropdownMode];
                const scaleFactor = parseFloat(document.documentElement.style.getPropertyValue('--scale-factor') || 1);
                
                // Clear existing boxes
                leftBoxElements.forEach(el => el.remove());
                rightBoxElements.forEach(el => el.remove());
                leftBoxElements = [];
                rightBoxElements = [];
                
                const totalHeightleft = (numLeftBoxes * boxHeight) + ((numLeftBoxes - 1) * spacing);
                const startYleft = (400 * scaleFactor - totalHeightleft) / 2;
                const leftBoxX = config.leftBoxX;
                
                // Create left boxes
                for (let i = 0; i < numLeftBoxes; i++) {
                    const el = document.createElement('div');
                    el.className = 'left-box';
                    el.classList.add(config.leftBoxClass);
                    el.textContent = leftBoxes[i] ? leftBoxes[i].label : '';
                    el.dataset.index = i;
                    el.style.left = leftBoxX + 'px';
                    el.style.top = (startYleft + (i * (boxHeight + spacing))) + 'px';
                    chartContainer.appendChild(el);
                    leftBoxElements.push(el);
                    
                    el.addEventListener('click', () => {
                        activeLeftBox = i;
                        switch (dropdownMode) {
                            case 0:
                                calculatedoms(activeNote);
                                dom7labels(dom1, dom2, dom3, dom4);
                                calculateresolutions(activeLeftBox);
                                resolutionlabels(res1, res2, res3, res4, res5, res6);
                                break;
                            case 1:
                                calculatepivots(activeNote);
                                resolutionlabels(piv1, piv2, piv3, piv4, piv5, piv6);
                                calculatedims(activeLeftBox);
                                dim7labels(dim1, dim2, dim3, dim4);
                                break;
                        }
                        updateLeftBoxes();
                        updateRightBoxes();
                        updateActiveStates();
                        drawLines();
                    });
                }
                
                // Create right boxes - always aligned with circle center
                const totalHeightright = (numRightBoxes * boxHeight) + ((numRightBoxes - 1) * spacing);
                const startYright = (400 * scaleFactor - totalHeightright) / 2;
                // Adjust rightBoxX to extend left when narrow
                const rightBoxX = dropdownMode === 0 ? leftBoxX + config.leftBoxWidth + 80 * scaleFactor : leftBoxX + config.leftBoxWidth + (100 - 40) * scaleFactor;
                
                for (let i = 0; i < numRightBoxes; i++) {
                    const el = document.createElement('div');
                    el.className = 'right-box';
                    el.classList.add(config.rightBoxClass);
                    el.textContent = rightBoxes[i] ? rightBoxes[i].label : '';
                    el.style.left = rightBoxX + 'px';
                    el.style.top = (startYright + (i * (boxHeight + spacing))) + 'px';
                    chartContainer.appendChild(el);
                    rightBoxElements.push(el);
                }
                
                updateRightBoxColors();
            }

            // ========================================
            // MUSIC THEORY CALCULATIONS
            // ========================================
            let dom1 = '', dom2 = '', dom3 = '', dom4 = '';
            let res1 = '', res2 = '', res3 = '', res4 = '', res5 = '', res6 = '';
            let piv1 = '', piv2 = '', piv3 = '', piv4 = '', piv5 = '', piv6 = '';
            let dim1 = '', dim2 = '', dim3 = '', dim4 = '';

            function rotateleft(list, k) {
                const n = list.length;
                k = list.length - k;
                k %= n;
                const rotated = [];
                for (let i = 0; i < n; i++) {
                    rotated[(i + k) % n] = list[i];
                }
                return rotated;
            }

            function calculatedoms(i) {
                let rotated5ths = rotateleft(notes, i);
                dom1 = rotated5ths[5];
                dom2 = rotated5ths[2];
                dom3 = rotated5ths[11];
                dom4 = rotated5ths[8];
            }

            function calculateresolutions(i) {
                const resolutionmap = [5, 2, 11, 8];
                let rotated5ths = rotateleft(notes, activeNote);
                let doublerotated5ths = rotateleft(rotated5ths, resolutionmap[i]);
                res1 = doublerotated5ths[11];
                res2 = doublerotated5ths[2];
                res3 = doublerotated5ths[7];
                res4 = doublerotated5ths[5];
                res5 = doublerotated5ths[8];
                res6 = doublerotated5ths[1];
            }

            function calculatepivots(i) {
                let rotated5ths = rotateleft(notes, i);
                piv1 = rotated5ths[1];
                piv2 = rotated5ths[10];
                piv3 = rotated5ths[5];
                piv4 = rotated5ths[7];
                piv5 = rotated5ths[4];
                piv6 = rotated5ths[11];
            }

            function calculatedims(i) {
                const resolutionmap = [1, 10, 5, 7, 4, 11];
                let rotated5ths = rotateleft(notes, activeNote);
                let doublerotated5ths = rotateleft(rotated5ths, resolutionmap[i]);
                dim1 = doublerotated5ths[7];
                dim2 = doublerotated5ths[10];
                dim3 = doublerotated5ths[1];
                dim4 = doublerotated5ths[4];
            }

            function dim7labels(i1, i2, i3, i4) {
                dimlist = [
                    { label: i1 + "°7" },
                    { label: i2 + "°7" },
                    { label: i3 + "°7" },
                    { label: i4 + "°7" }
                ];
                rightBoxes = dimlist;
            }

            function dom7labels(i1, i2, i3, i4) {
                domlist = [
                    { label: i1 + "7" },
                    { label: i2 + "7" },
                    { label: i3 + "7" },
                    { label: i4 + "7" }
                ];
                leftBoxes = domlist;
            }

            function resolutionlabels(i1, i2, i3, i4, i5, i6) {
                switch (dropdownMode) {
                    case 0:
                        reslist = [
                            { label: " " + i1 + " (Perfect)" },
                            { label: " " + i2 + " (Back Door)" },
                            { label: " " + i3 + " (Screen Door)" },
                            { label: " " + i4 + " (Tritone Perfect)" },
                            { label: " " + i5 + " (Tritone Back Door)" },
                            { label: " " + i6 + " (Tritone Screen Door / Plagal)" }
                        ];
                        rightBoxes = reslist;
                        break;
                    case 1:
                        dompivotlist = [
                            { label: " " + i1 + "7 (Perfect)" },
                            { label: " " + i2 + "7 (Back Door)" },
                            { label: " " + i3 + "7 (Screen Door)" },
                            { label: " " + i4 + "7 (Tritone Perfect)" },
                            { label: " " + i5 + "7 (Tritone Back Door)" },
                            { label: " " + i6 + "7 (Tritone Screen Door / Plagal)" }
                        ];
                        leftBoxes = dompivotlist;
                        break;
                }
            }

            function updateCenterText() {
                centerTextElement.textContent = centerText;
            }

            function updateNotePositions() {
                const scaleFactor = parseFloat(document.documentElement.style.getPropertyValue('--scale-factor') || 1);
                noteElements.forEach((el, i) => {
                    const angle = (i * 30 - rotationOffset) * Math.PI / 180;
                    const x = centerX + Math.cos(angle) * outerRadius;
                    const y = centerY + Math.sin(angle) * outerRadius;
                    el.style.left = x + 'px';
                    el.style.top = y + 'px';
                });
            }

            function updateActiveStates() {
                const config = MODE_CONFIG[dropdownMode];
                noteElements.forEach((el, i) => {
                    el.classList.remove('active', 'red', 'green');
                    if (i === activeNote) {
                        el.classList.add('active');
                        el.classList.add(config.circleActiveClass);
                    }
                });
                leftBoxElements.forEach((el, i) => {
                    el.classList.toggle('active', i === activeLeftBox);
                });
            }

            function updateRightBoxColors() {
                const config = MODE_CONFIG[dropdownMode];
                rightBoxElements.forEach(el => {
                    el.classList.remove('green', 'red');
                    el.classList.add(config.rightBoxColorClass);
                });
            }

            function updateLeftBoxes() {
                switch (dropdownMode) {
                    case 0:
                        leftBoxes = domlist;
                        break;
                    case 1:
                        leftBoxes = dompivotlist;
                        break;
                }
                leftBoxElements.forEach((el, i) => {
                    el.textContent = leftBoxes[i] ? leftBoxes[i].label : '';
                });
            }

            function updateRightBoxes() {
                switch (dropdownMode) {
                    case 0:
                        rightBoxes = reslist;
                        break;
                    case 1:
                        rightBoxes = dimlist;
                        break;
                }
                rightBoxElements.forEach((el, i) => {
                    el.textContent = rightBoxes[i] ? rightBoxes[i].label : '';
                });
            }

            function drawLines() {
                const config = MODE_CONFIG[dropdownMode];
                const convergencePointX = 5 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor'));
                const convergenceY = 200 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor'));
              
                let paths = '';

                const totalHeightleft = (numLeftBoxes * boxHeight) + ((numLeftBoxes - 1) * spacing);
                const startYleft = (400 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor')) - totalHeightleft) / 2;
                const leftBoxX = config.leftBoxX;

                const leftBoxWidth = config.leftBoxWidth;
                const rightBoxX = dropdownMode === 0 ? leftBoxX + leftBoxWidth + 80 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor')) : 
                                                     leftBoxX + leftBoxWidth + (100 - 40) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor'));

                const totalHeightright = (numRightBoxes * boxHeight) + ((numRightBoxes - 1) * spacing);
                const startYright = (400 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor')) - totalHeightright) / 2;
                
                // Get curvature from config
                const curvature = config.curvature;
                
                // Left lines
                for (let i = 0; i < numLeftBoxes; i++) {
                    const boxY = startYleft + (i * (boxHeight + spacing));
                    const boxCenterY = boxY + boxHeight / 2;
                    const controlX1 = convergencePointX + curvature;
                    const controlX2 = leftBoxX - curvature;
                    
                    paths += `<path d="M ${convergencePointX} ${convergenceY} C ${controlX1} ${convergenceY}, ${controlX2} ${boxCenterY}, ${leftBoxX} ${boxCenterY}" stroke="rgba(255, 255, 255, 1)" stroke-width="${2 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor'))}" fill="none"/>`;
                }
                
                // Right lines
                const activeBoxY = startYleft + (activeLeftBox * (boxHeight + spacing));
                const activeBoxCenterY = activeBoxY + boxHeight / 2;
                const activeBoxRightX = leftBoxX + leftBoxWidth + 10 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor'));
                
                for (let i = 0; i < numRightBoxes; i++) {
                    const rightBoxY = startYright + (i * (boxHeight + spacing));
                    const rightBoxCenterY = rightBoxY + boxHeight / 2;
                    const controlX1 = activeBoxRightX + curvature;
                    const controlX2 = rightBoxX - curvature;
                    
                    // Modified this line to stop at rightBoxX rather than going into the box
                    paths += `<path d="M ${activeBoxRightX} ${activeBoxCenterY} C ${controlX1} ${activeBoxCenterY}, ${controlX2} ${rightBoxCenterY}, ${rightBoxX} ${rightBoxCenterY}" stroke="rgba(255, 255, 255, 1)" stroke-width="${2 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scale-factor'))}" fill="none"/>`;
                }
                
                svgLines.innerHTML = paths;
            }

            // ========================================
            // ANIMATION
            // ========================================
            function animate() {
                if (!animating) return;
                
                let diff = targetRotation - rotationOffset;
                while (diff > 180) diff -= 360;
                while (diff < -180) diff += 360;
                
                if (Math.abs(diff) < 0.5) {
                    rotationOffset = targetRotation;
                    animating = false;
                    updateNotePositions();
                    return;
                }
                
                rotationOffset += diff * animationSpeed;
                while (rotationOffset >= 360) rotationOffset -= 360;
                while (rotationOffset < 0) rotationOffset += 360;
                
                updateNotePositions();
                requestAnimationFrame(animate);
            }

            // ========================================
            // INITIALIZATION
            // ========================================
            function init() {
                // Set initial scale
                updateScaleFactor();
                
                createBoxes();
                calculatedoms(activeNote);
                dom7labels(dom1, dom2, dom3, dom4);
                calculateresolutions(activeLeftBox);
                resolutionlabels(res1, res2, res3, res4, res5, res6);
                updateLeftBoxes();
                updateRightBoxes();
                updateNotePositions();
                updateActiveStates();
                updateCenterText();
                drawLines();
                
                initialized = true;
            }

            // ========================================
            // DROPDOWN MODE SWITCHING
            // ========================================
            const dropdown = document.getElementById('dropdown');
            dropdown.addEventListener('change', (e) => {
            const selectedIndex = parseInt(e.target.value);
            dropdownMode = selectedIndex;
            
            const config = MODE_CONFIG[dropdownMode];
            
            // Update UI labels
            document.getElementById('left-label').textContent = config.leftLabel;
            document.getElementById('right-label').textContent = config.rightLabel;
            document.getElementById('arrow').innerHTML = config.arrowSVG;
            centerTextElement.textContent = config.centerText;
            
            // Update box counts from config
            numLeftBoxes = config.numLeftBoxes;
            numRightBoxes = config.numRightBoxes;
            
            // Reset active box to 0
            activeLeftBox = 0;
            
            // Recreate boxes with new configuration
            createBoxes();
            switch (dropdownMode) {
                case 0:
                    calculatedoms(activeNote);
                    dom7labels(dom1, dom2, dom3, dom4);
                    calculateresolutions(activeLeftBox);
                    resolutionlabels(res1, res2, res3, res4, res5, res6);
                    break;
                case 1:
                    calculatepivots(activeNote);
                    resolutionlabels(piv1, piv2, piv3, piv4, piv5, piv6);
                    calculatedims(activeLeftBox);
                    dim7labels(dim1, dim2, dim3, dim4);
                    break;
            }
            updateLeftBoxes();
            updateRightBoxes();
            updateActiveStates();
            drawLines();
            });

            // ========================================
            // WINDOW RESIZE HANDLING
            // ========================================
            window.addEventListener('resize', updateScaleFactor);

            // Initialize after DOM is fully loaded
            document.addEventListener('DOMContentLoaded', init);
        </script>
    </body>
</whole>
</html>
